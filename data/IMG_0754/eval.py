"""
Evaluation Functions for: IMG_0754
Task Type: slide
Auto-generated by Gemini Video Analysis
"""

import numpy as np
from typing import Dict, Tuple, Any

# ============ SUCCESS CRITERIA ============

def is_contacted(env) -> bool:
    """Hand makes contact with the object"""
    data = env.unwrapped.data
    model = env.unwrapped.model
    obj_pos = data.xpos[model.body("Object").id]
    n_contacts = data.ncon
    obj_height = obj_pos[2]
    target_pos = getattr(env, 'target_pos', np.array([0.3, 0.0, 0.2]))
    dist_to_target = np.linalg.norm(obj_pos - target_pos)
    return n_contacts > 0

def reached_target(env) -> bool:
    """The object has been moved to a new location"""
    data = env.unwrapped.data
    model = env.unwrapped.model
    obj_pos = data.xpos[model.body("Object").id]
    n_contacts = data.ncon
    obj_height = obj_pos[2]
    target_pos = getattr(env, 'target_pos', np.array([0.3, 0.0, 0.2]))
    dist_to_target = np.linalg.norm(obj_pos - target_pos)
    return np.linalg.norm(obj_final_pos - obj_start_pos) > 0.1


# ============ METRICS ============

def compute_slide_distance(env) -> float:
    """Total distance the object was moved"""
    data = env.unwrapped.data
    model = env.unwrapped.model
    obj_pos = data.xpos[model.body("Object").id]
    n_contacts = data.ncon
    target_pos = getattr(env, 'target_pos', np.array([0.3, 0.0, 0.2]))
    return float(np.linalg.norm(obj_pos_at_release - obj_pos_at_grasp))

def compute_movement_smoothness(env) -> float:
    """Measure of how steady the slide was"""
    data = env.unwrapped.data
    model = env.unwrapped.model
    obj_pos = data.xpos[model.body("Object").id]
    n_contacts = data.ncon
    target_pos = getattr(env, 'target_pos', np.array([0.3, 0.0, 0.2]))
    return float(1 / np.std(obj_velocity_during_slide))


# ============ EVALUATION SUITE ============

class EvalSuite:
    """Complete evaluation suite for this task."""

    def __init__(self, env):
        self.env = env
        self.success_checks = [
            ("contacted", is_contacted), ("reached_target", reached_target)
        ]
        self.metric_fns = [
            ("slide_distance", compute_slide_distance), ("movement_smoothness", compute_movement_smoothness)
        ]

    def check_success(self) -> Tuple[bool, Dict[str, bool]]:
        results = {}
        for name, fn in self.success_checks:
            try:
                results[name] = fn(self.env)
            except:
                results[name] = False
        return all(results.values()), results

    def compute_metrics(self) -> Dict[str, float]:
        metrics = {}
        for name, fn in self.metric_fns:
            try:
                metrics[name] = fn(self.env)
            except:
                metrics[name] = float('nan')
        return metrics

    def evaluate_step(self) -> Dict[str, Any]:
        success, milestone_progress = self.check_success()
        metrics = self.compute_metrics()
        return {"success": success, "metrics": metrics, "milestone_progress": milestone_progress}
